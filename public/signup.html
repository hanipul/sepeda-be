<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Registrasi Pengguna</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header><h1>Registrasi Pengguna</h1></header>

  <main>
    <input type="text" id="name" placeholder="Nama lengkap" required />
    <input type="number" id="weight" placeholder="Berat badan (kg)" required />
    
    <select id="gender" required>
      <option value="">Pilih Jenis Kelamin</option>
      <option value="1">Laki-laki</option>
      <option value="2">Perempuan</option>
    </select>

    <button onclick="startCardRegistration()">Lanjutkan dan Tempelkan Kartu</button>

    <p id="status" style="margin-top: 20px; font-weight: bold;">⏳ Menunggu kartu RFID...</p>
  </main>

  <footer><p>&copy; 2025 Fitness Tracker</p></footer>

  <script>
    const BASE_URL = 'http://192.168.43.42:3000';
    let polling;

    function startCardRegistration() {
      const name = document.getElementById('name').value;
      const weight = document.getElementById('weight').value;
      const gender = document.getElementById('gender').value;

      if (!name || !weight || !gender) {
        alert('❗ Harap isi semua data terlebih dahulu!');
        return;
      }

      document.getElementById('status').innerText = 'Tempelkan kartu RFID Anda...';

      polling = setInterval(async () => {
        try {
          const res = await fetch(BASE_URL + '/scan/card');
          if (res.ok) {
            const data = await res.json();
            const cardId = data.cardId;
            clearInterval(polling);

            const registerRes = await fetch(BASE_URL + '/users', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ cardId, name, weight, gender })
            });

            const registerData = await registerRes.json();
            if (registerRes.ok) {
              alert('✅ Registrasi berhasil!');
              window.location.href = '/index.html';
            } else {
              alert('❌ Gagal registrasi: ' + registerData.message);
              document.getElementById('status').innerText = '❌ Registrasi gagal.';
            }
          }
        } catch (err) {
          console.error('Polling error:', err);
          document.getElementById('status').innerText = '❌ Terjadi kesalahan.';
        }
      }, 2000);
    }
  </script>
</body>
</html>
